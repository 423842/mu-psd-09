# 音声感情分析アプリ 設計ドキュメント

## 1. 概要 (Overview)

このアプリケーションは、ユーザーが提供した音声データから感情を分析し、結果を視覚的に表示するWebアプリケーションです。
ユーザーはローカルのWAVファイルをアップロードするか、ブラウザのマイクを使用してリアルタイムに音声を録音することができます。
バックエンドAPIと連携し、音声からテキストを書き起こし、主要な感情（喜び、悲しみ、怒りなど）のスコアを算出します。

## 2. 機能一覧 (Features)

- **タブ切り替え**:
  - 「WAVファイル」アップロード機能と「音声を録音」機能をタブで切り替えることができます。
- **ファイルアップロード機能**:
  - ユーザーはローカルにあるWAVファイルをアップロードして分析できます。
  - 解析中はボタンが無効化され、「解析中...」のアニメーションが表示されます。
- **音声録音機能**:
  - ブラウザのマイクを使用して音声を録音できます（WebM形式）。
  - 録音開始前に3秒間のカウントダウンが表示されます。
  - 録音は最大10秒で、残り時間を示すプログレスバーが表示されます。
  - 録音中は「録音中」インジケーターが表示され、ボタンの状態が適切に制御されます。
  - 録音された音声はクライアントサイドでWAV形式に変換された後、バックエンドに送信されます。
- **感情分析結果表示**:
  - 分析が完了すると、以下の情報が表示されます。
    - 音声から書き起こされたテキスト。
    - 書き起こしテキストが空の場合は、「音声が入力されていません」と表示され、感情スコアは表示されません。
    - 最も割合の大きい感情とそのスコアのサマリー。
    - 各感情のスコアをパーセンテージと棒グラフで一覧表示。
- **動的なUIフィードバック**:
  - 解析中は「解析中...」のテキストがアニメーションします。
  - 解析結果が表示されると、最も割合の大きい感情の色がページの背景色として薄く適用されます。
  - サマリーの感情テキストは、その感情に対応した色で表示されます。

## 3. 技術スタック (Tech Stack)

- **フロントエンド**:
  - **フレームワーク**: Vue.js 2
  - **HTTPクライアント**: Axios (バックエンドAPIとの通信用)
  - **音声処理**: FFmpeg.wasm (クライアントサイドでのWebMからWAVへの音声形式変換用)
- **バックエンド (想定)**:
  - `/api/upload` エンドポイントを持つサーバー。
  - 音声ファイルを受け取り、音声認識と感情分析を実行するAPI。

## 4. コンポーネント構成 (Component Structure)

現在、すべての機能は単一のコンポーネント `App.vue` に実装されています。

### `App.vue`

- **`data`**:
  - `selectedTab`: 現在選択されているタブ ('file' or 'record')。
  - `loading`, `recording`: アプリケーションの状態（ローディング中、録音中など）を管理するフラグ。
  - `selectedFile`, `recordedFile`: ユーザーが提供した音声ファイルデータ。
  - `result`: バックエンドから受け取った分析結果オブジェクト。
  - `emotionColors`: 各感情と表示色をマッピングするオブジェクト。
  - `loadingDotsCount`, `loadingInterval`: ローディングアニメーション用のデータ。
  - `remainingTime`, `recordingTimer`: 録音の残り時間とプログレスバー制御用のタイマー。
  - `countdown`, `countdownInterval`: 録音開始前のカウントダウン制御用データ。
  - `tabAtRequestStart`: 解析開始時のタブを記録し、非同期処理の結果表示を制御する。

- **`computed`**:
  - `dominantEmotion`: `result` から最もスコアの高い感情を算出する。

- **`watch`**:
  - `loading`: `loading` フラグの変更を監視し、ローディングアニメーションの開始/停止を制御する。
  - `dominantEmotion`: `dominantEmotion` の変更を監視し、ページの背景色を動的に変更する。
  - `selectedTab`: タブの変更を監視し、録音やカウントダウンを中止する。

- **`methods`**:
  - `selectTab`: タブを切り替え、関連データをリセットする。
  - `handleFileUpload`, `uploadFile`: ファイルアップロードとAPIへの送信を処理する。
  - `initiateRecording`: 3秒のカウントダウンを開始する。
  - `startRecording`, `stopRecording`: マイク録音の開始/停止、および関連タイマーを制御する。
  - `uploadRecordedAudio`: 録音された音声をFFmpegでWAVに変換し、APIへ送信する。
  - `getOpaqueColor`: `rgba` カラーを不透明な `rgb` カラーに変換するヘルパー。

## 5. APIインターフェース (API Interface)

### `POST /api/upload`

- **リクエスト**:
  - `Content-Type`: `multipart/form-data`
  - `Body`: `file` というキーで音声ファイル（WAV形式）を含むフォームデータ。

- **レスポンス (成功時)**:
  - `Status`: `200 OK`
  - `Body` (JSON):
    ```json
    {
      "transcription": "ここに書き起こされたテキストが入ります。",
      "emotions": [
        { "label": "喜び", "score": "98.86" },
        { "label": "悲しみ", "score": "0.50" },
        // ... 他の感情
      ]
    }
    ```

- **レスポンス (失敗時)**:
  - エラー情報を含むJSONオブジェクト。

## 6. スタイルとUI/UX (Styling and UI/UX)

- 全体的に中央揃えのレイアウト。
- タブUIにより、機能へのアクセスが明確。
- ボタンは状態（有効、無効、ホバー）に応じてスタイルが変化し、直感的な操作をサポート。
- 感情スコアはカスタムプロパティ (`--score-width`, `--score-color`) を利用した横向き棒グラフで視覚化される。

## 7. 今後の改善案 (Future Improvements)

- **コンポーネント分割**:
  - `App.vue` が肥大化しているため、以下の単位でコンポーネントを分割する。
    - `FileUpload.vue`: ファイルアップロードタブの機能。
    - `AudioRecorder.vue`: 音声録音タブの機能。
    - `AnalysisResult.vue`: 分析結果の表示部分。
- **エラーハンドリングの強化**:
  - APIエラーやマイクへのアクセス失敗時に、`console.error` だけでなく、ユーザーに分かりやすいエラーメッセージをUI上に表示する。
- **グラフの可視化改善**:
  - 棒グラフだけでなく、円グラフなど他の表現方法を選択できるようにする。
- **状態管理の導入**:
  - アプリケーションがさらに複雑化する場合、VuexやPiniaなどの状態管理ライブラリを導入し、状態の受け渡しを整理する。
